name: Sync Wazuh versions

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - sync
          - set-default
          - add-version
          - remove-version
        default: sync
      wazuh_version:
        description: 'Wazuh version (e.g., 4.14.2) - required for set-default/add/remove'
        required: false
        type: string
      chart_version:
        description: 'Chart version to use (v1, v2) - only for add-version'
        required: false
        type: string
        default: 'v1'
      auto_release:
        description: 'Automatically trigger release after update'
        required: false
        type: choice
        options:
          - 'none'
          - 'pr'
          - 'direct'
        default: 'none'

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  VERSIONS_FILE: supported-versions.json

jobs:
  manage-versions:
    name: Manage Wazuh versions
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.result.outputs.updated }}
      new_version: ${{ steps.result.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Wazuh versions from GitHub
        id: wazuh_versions
        run: |
          echo "Fetching Wazuh tags from GitHub..."

          # Fetch tags from Wazuh repository (v4.x.x and v5.x.x format)
          TAGS=$(curl -s "https://api.github.com/repos/wazuh/wazuh/tags?per_page=100" | \
            jq -r '.[].name' | \
            grep -E '^v[45]\.[0-9]+\.[0-9]+$' | \
            sort -V)

          echo "Available Wazuh versions:"
          echo "$TAGS"

          # Get latest v4.x version (without v prefix)
          LATEST_V4=$(echo "$TAGS" | grep '^v4\.' | tail -1 | sed 's/^v//')
          echo "Latest v4.x version: $LATEST_V4"

          # Get latest v5.x version if exists
          LATEST_V5=$(echo "$TAGS" | grep '^v5\.' | tail -1 | sed 's/^v//' || echo "")
          echo "Latest v5.x version: ${LATEST_V5:-none}"

          echo "latest_v4=${LATEST_V4}" >> $GITHUB_OUTPUT
          echo "latest_v5=${LATEST_V5}" >> $GITHUB_OUTPUT

          # Create JSON array
          VERSIONS_JSON=$(echo "$TAGS" | sed 's/^v//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "versions_json=${VERSIONS_JSON}" >> $GITHUB_OUTPUT

      - name: Load current configuration
        id: config
        run: |
          if [ -f "${{ env.VERSIONS_FILE }}" ]; then
            CURRENT_DEFAULT=$(jq -r '.default_version' ${{ env.VERSIONS_FILE }})
            MIN_VERSION=$(jq -r '.minimum_version' ${{ env.VERSIONS_FILE }})
          else
            CURRENT_DEFAULT=""
            MIN_VERSION="4.13.0"
          fi

          echo "current_default=${CURRENT_DEFAULT}" >> $GITHUB_OUTPUT
          echo "min_version=${MIN_VERSION}" >> $GITHUB_OUTPUT

      - name: Sync versions from upstream
        if: github.event.inputs.action == 'sync' || github.event_name == 'schedule'
        id: sync
        run: |
          LATEST_V4="${{ steps.wazuh_versions.outputs.latest_v4 }}"
          MIN_VERSION="${{ steps.config.outputs.min_version }}"
          UPSTREAM_VERSIONS='${{ steps.wazuh_versions.outputs.versions_json }}'

          # Filter versions >= minimum version using proper semver comparison
          # Split versions into parts and compare numerically
          FILTERED_VERSIONS=$(echo "$UPSTREAM_VERSIONS" | jq -c --arg min "$MIN_VERSION" '
            def semver_parts: split(".") | map(tonumber);
            def semver_gte($a; $b):
              ($a | semver_parts) as $ap |
              ($b | semver_parts) as $bp |
              if $ap[0] > $bp[0] then true
              elif $ap[0] < $bp[0] then false
              elif $ap[1] > $bp[1] then true
              elif $ap[1] < $bp[1] then false
              else $ap[2] >= $bp[2]
              end;
            map(select(semver_gte(.; $min))) |
            sort_by(split(".") | map(tonumber)) |
            reverse
          ')

          echo "Filtered versions (>= $MIN_VERSION): $FILTERED_VERSIONS"

          # Get excluded versions from config
          EXCLUDED=$(jq -r '.excluded_versions // [] | .[]' ${{ env.VERSIONS_FILE }} 2>/dev/null || echo "")

          # Build new versions array with chart_version based on major version
          NEW_VERSIONS=$(echo "$FILTERED_VERSIONS" | jq -c --arg latest "$LATEST_V4" --argjson excluded "$(echo "$EXCLUDED" | jq -R -s -c 'split("\n") | map(select(length > 0))')" '
            map(select(. as $v | $excluded | index($v) | not)) |
            map({
              version: .,
              chart_version: (if (. | startswith("5.")) then "v2" else "v1" end),
              supported: true,
              default: (. == $latest)
            }) |
            sort_by(.version | split(".") | map(tonumber)) |
            reverse
          ')

          # Update supported-versions.json
          jq --argjson versions "$NEW_VERSIONS" --arg latest "$LATEST_V4" --arg now "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '
            .versions = $versions |
            .default_version = $latest |
            .last_sync = $now
          ' ${{ env.VERSIONS_FILE }} > tmp.json && mv tmp.json ${{ env.VERSIONS_FILE }}

          echo "Updated ${{ env.VERSIONS_FILE }}"
          cat ${{ env.VERSIONS_FILE }}

          echo "new_default=${LATEST_V4}" >> $GITHUB_OUTPUT

      - name: Set default version
        if: github.event.inputs.action == 'set-default'
        id: set_default
        run: |
          VERSION="${{ github.event.inputs.wazuh_version }}"
          VERSION="${VERSION#v}"

          if [ -z "$VERSION" ]; then
            echo "::error::Version is required for set-default action"
            exit 1
          fi

          if ! jq -e --arg v "$VERSION" '.versions[] | select(.version == $v)' ${{ env.VERSIONS_FILE }} > /dev/null; then
            echo "::error::Version $VERSION is not in supported versions"
            exit 1
          fi

          jq --arg v "$VERSION" '
            .default_version = $v |
            .versions = [.versions[] | .default = (.version == $v)]
          ' ${{ env.VERSIONS_FILE }} > tmp.json && mv tmp.json ${{ env.VERSIONS_FILE }}

          echo "Set default version to $VERSION"
          echo "new_default=${VERSION}" >> $GITHUB_OUTPUT

      - name: Add version
        if: github.event.inputs.action == 'add-version'
        id: add_version
        run: |
          VERSION="${{ github.event.inputs.wazuh_version }}"
          VERSION="${VERSION#v}"
          CHART_VERSION="${{ github.event.inputs.chart_version }}"

          if [ -z "$VERSION" ]; then
            echo "::error::Version is required for add-version action"
            exit 1
          fi

          # Determine chart_version from major version if not specified
          if [ -z "$CHART_VERSION" ]; then
            if [[ "$VERSION" == 5.* ]]; then
              CHART_VERSION="v2"
            else
              CHART_VERSION="v1"
            fi
          fi

          UPSTREAM_VERSIONS='${{ steps.wazuh_versions.outputs.versions_json }}'
          if ! echo "$UPSTREAM_VERSIONS" | jq -e --arg v "$VERSION" 'index($v) != null' > /dev/null; then
            echo "::warning::Version $VERSION not found in upstream Wazuh releases"
          fi

          if jq -e --arg v "$VERSION" '.versions[] | select(.version == $v)' ${{ env.VERSIONS_FILE }} > /dev/null; then
            echo "Version $VERSION already exists"
            exit 0
          fi

          jq --arg v "$VERSION" --arg cv "$CHART_VERSION" '
            .versions = (.versions + [{version: $v, chart_version: $cv, supported: true, default: false}]) |
            .versions = (.versions | sort_by(.version | split(".") | map(tonumber)) | reverse)
          ' ${{ env.VERSIONS_FILE }} > tmp.json && mv tmp.json ${{ env.VERSIONS_FILE }}

          jq --arg v "$VERSION" '
            .excluded_versions = (.excluded_versions // [] | map(select(. != $v)))
          ' ${{ env.VERSIONS_FILE }} > tmp.json && mv tmp.json ${{ env.VERSIONS_FILE }}

          echo "Added version $VERSION with chart $CHART_VERSION"

      - name: Remove version
        if: github.event.inputs.action == 'remove-version'
        id: remove_version
        run: |
          VERSION="${{ github.event.inputs.wazuh_version }}"
          VERSION="${VERSION#v}"

          if [ -z "$VERSION" ]; then
            echo "::error::Version is required for remove-version action"
            exit 1
          fi

          CURRENT_DEFAULT=$(jq -r '.default_version' ${{ env.VERSIONS_FILE }})
          if [ "$VERSION" == "$CURRENT_DEFAULT" ]; then
            echo "::error::Cannot remove default version. Set a new default first."
            exit 1
          fi

          jq --arg v "$VERSION" '
            .versions = [.versions[] | select(.version != $v)]
          ' ${{ env.VERSIONS_FILE }} > tmp.json && mv tmp.json ${{ env.VERSIONS_FILE }}

          jq --arg v "$VERSION" '
            .excluded_versions = ((.excluded_versions // []) + [$v] | unique)
          ' ${{ env.VERSIONS_FILE }} > tmp.json && mv tmp.json ${{ env.VERSIONS_FILE }}

          echo "Removed version $VERSION and added to exclusion list"

      - name: Determine new default version
        id: new_default
        run: |
          if [ -n "${{ steps.sync.outputs.new_default }}" ]; then
            NEW_DEFAULT="${{ steps.sync.outputs.new_default }}"
          elif [ -n "${{ steps.set_default.outputs.new_default }}" ]; then
            NEW_DEFAULT="${{ steps.set_default.outputs.new_default }}"
          else
            NEW_DEFAULT=$(jq -r '.default_version' ${{ env.VERSIONS_FILE }})
          fi

          echo "new_default=${NEW_DEFAULT}" >> $GITHUB_OUTPUT

      - name: Update chart files with default version
        id: update_chart
        run: |
          NEW_DEFAULT="${{ steps.new_default.outputs.new_default }}"

          # Get chart_version for the default version
          CHART_VERSION=$(jq -r --arg v "$NEW_DEFAULT" '.versions[] | select(.version == $v) | .chart_version // "v1"' ${{ env.VERSIONS_FILE }})
          CHART_PATH="charts/${CHART_VERSION}"

          CURRENT_TAG=$(grep '^  tag:' ${CHART_PATH}/values.yaml | head -1 | awk -F'"' '{print $2}')

          echo "Current image tag: ${CURRENT_TAG}"
          echo "New default: ${NEW_DEFAULT}"
          echo "Chart path: ${CHART_PATH}"

          if [ "${CURRENT_TAG}" != "${NEW_DEFAULT}" ]; then
            # Update image tag in values.yaml
            sed -i "s/tag: \"[0-9]*\.[0-9]*\.[0-9]*\"/tag: \"${NEW_DEFAULT}\"/" ${CHART_PATH}/values.yaml

            # Update version and appVersion in Chart.yaml
            sed -i "s/^version:.*/version: ${NEW_DEFAULT}/" ${CHART_PATH}/Chart.yaml
            sed -i "s/^appVersion:.*/appVersion: \"${NEW_DEFAULT}\"/" ${CHART_PATH}/Chart.yaml

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No chart update needed"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Set result outputs
        id: result
        run: |
          echo "updated=${{ steps.update_chart.outputs.updated || 'false' }}" >> $GITHUB_OUTPUT
          echo "new_version=${{ steps.new_default.outputs.new_default }}" >> $GITHUB_OUTPUT

      - name: Create pull request
        id: create_pr
        if: steps.update_chart.outputs.updated == 'true' && github.event.inputs.auto_release != 'direct'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Wazuh agent to ${{ steps.new_default.outputs.new_default }}"
          title: "chore: update Wazuh agent to ${{ steps.new_default.outputs.new_default }}"
          body: |
            ## Wazuh agent version update

            **Action:** ${{ github.event.inputs.action || 'sync' }}

            ### Changes
            - Updated default Wazuh version to **${{ steps.new_default.outputs.new_default }}**
            - Updated `image.tag` in `values.yaml`
            - Updated `version` and `appVersion` in `Chart.yaml`

            ### Supported versions
            ```json
            $(jq '.versions' ${{ env.VERSIONS_FILE }})
            ```

            ### Wazuh release notes
            - [Wazuh ${{ steps.new_default.outputs.new_default }}](https://github.com/wazuh/wazuh/releases/tag/v${{ steps.new_default.outputs.new_default }})

            ---
            *This PR was automatically created by the sync-wazuh-versions workflow.*
          branch: "chore/wazuh-${{ steps.new_default.outputs.new_default }}"
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Enable PR auto-merge
        if: steps.create_pr.outputs.pull-request-number && (github.event_name == 'schedule' || github.event.inputs.auto_release == 'pr')
        run: |
          gh pr merge ${{ steps.create_pr.outputs.pull-request-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit for direct release
        if: steps.update_chart.outputs.updated == 'true' && github.event.inputs.auto_release == 'direct'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore: update Wazuh agent to ${{ steps.new_default.outputs.new_default }}"
          git push

      - name: Trigger release workflow
        if: steps.update_chart.outputs.updated == 'true' && github.event.inputs.auto_release == 'direct'
        run: |
          gh workflow run release-helm.yml \
            -f publish_all_versions=true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## Wazuh version management results

          **Action:** ${{ github.event.inputs.action || 'sync' }}
          **Auto release:** ${{ github.event_name == 'schedule' && 'pr' || github.event.inputs.auto_release || 'none' }}

          ### Configuration
          | Item | Value |
          |------|-------|
          | Default version | ${{ steps.new_default.outputs.new_default }} |
          | Chart updated | ${{ steps.update_chart.outputs.updated || 'false' }} |
          | PR created | ${{ steps.create_pr.outputs.pull-request-number || 'N/A' }} |

          ### Supported versions
          ```json
          EOF
          jq '.versions' ${{ env.VERSIONS_FILE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
