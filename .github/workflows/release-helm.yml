name: Release Helm Chart

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0 or v1.0.0)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  HELM_CHART_PATH: chart

jobs:
  release:
    name: Release Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Convert repository owner to lowercase
        id: lowercase
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=${OWNER_LOWER}" >> $GITHUB_OUTPUT

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            if [[ ! "$VERSION" =~ ^v ]] && [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              VERSION="v${VERSION}"
            fi
          else
            VERSION="v$(cat ${{ env.HELM_CHART_PATH }}/Chart.yaml | grep '^version:' | awk '{print $2}')"
          fi

          # Remove 'v' prefix for Helm version
          HELM_VERSION="${VERSION#v}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "helm_version=${HELM_VERSION}" >> $GITHUB_OUTPUT

          # Check if this is a pre-release
          if [[ "$VERSION" =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "Release version: ${VERSION}"
          echo "Helm version: ${HELM_VERSION}"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Update Chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.helm_version }}/" ${{ env.HELM_CHART_PATH }}/Chart.yaml

          echo "Updated Chart.yaml:"
          cat ${{ env.HELM_CHART_PATH }}/Chart.yaml

      - name: Lint Helm chart
        run: |
          helm lint ${{ env.HELM_CHART_PATH }}

      - name: Package Helm chart
        run: |
          helm package ${{ env.HELM_CHART_PATH }} --version ${{ steps.version.outputs.helm_version }}

      - name: Push Helm chart to OCI registry
        run: |
          CHART_FILE="wazuh-agent-${{ steps.version.outputs.helm_version }}.tgz"
          helm push "${CHART_FILE}" oci://${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/charts

      - name: Generate release notes
        id: release_notes
        run: |
          PREVIOUS_TAG=$(git tag -l --sort=-version:refname | grep -v "^${{ steps.version.outputs.version }}$" | head -n 1)

          cat << EOF > release_notes.md
          ## Wazuh Agent Helm Chart ${{ steps.version.outputs.version }}

          ### Installation

          \`\`\`bash
          helm install wazuh-agent oci://${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/charts/wazuh-agent \\
            --version ${{ steps.version.outputs.helm_version }} \\
            --namespace wazuh \\
            --create-namespace \\
            --set manager.address=<WAZUH_MANAGER_IP> \\
            --set registration.password=<PASSWORD>
          \`\`\`

          ### What's Changed
          EOF

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD --no-merges | head -20 >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${{ steps.version.outputs.version }}" >> release_notes.md
          else
            echo "Initial release" >> release_notes.md
          fi

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          files: |
            wazuh-agent-*.tgz
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Release ${{ steps.version.outputs.version }} Published

          ### Helm Chart

          \`\`\`bash
          helm install wazuh-agent oci://${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/charts/wazuh-agent --version ${{ steps.version.outputs.helm_version }}
          \`\`\`

          ### Links
          - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})
          - [Helm Chart](https://${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/charts/wazuh-agent)
          EOF
