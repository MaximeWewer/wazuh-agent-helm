name: Release Helm chart

on:
  push:
    tags:
      - '*.*.*'
    paths:
      - 'charts/**'
      - 'supported-versions.json'
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - 'charts/**'
  workflow_dispatch:
    inputs:
      publish_all_versions:
        description: 'Publish chart for all supported Wazuh versions'
        required: false
        type: boolean
        default: false
      wazuh_version:
        description: 'Specific Wazuh version to publish (ignored if publish_all_versions is true)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  VERSIONS_FILE: supported-versions.json

jobs:
  prepare:
    name: Prepare release
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    outputs:
      matrix: ${{ steps.versions.outputs.matrix }}
      default_version: ${{ steps.versions.outputs.default }}
      owner_lower: ${{ steps.lowercase.outputs.owner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Convert repository owner to lowercase
        id: lowercase
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=${OWNER_LOWER}" >> $GITHUB_OUTPUT

      - name: Determine Wazuh versions to publish
        id: versions
        run: |
          # Get default version
          DEFAULT_VERSION=$(jq -r '.default_version' ${{ env.VERSIONS_FILE }})
          echo "default=${DEFAULT_VERSION}" >> $GITHUB_OUTPUT

          if [ "${{ github.event.inputs.publish_all_versions }}" == "true" ]; then
            # All supported versions with their chart_version
            MATRIX=$(jq -c '[.versions[] | select(.supported == true) | {version: .version, chart_version: .chart_version}]' ${{ env.VERSIONS_FILE }})
            echo "Publishing all supported versions"
          elif [ -n "${{ github.event.inputs.wazuh_version }}" ]; then
            # Specific version - find its chart_version
            VERSION="${{ github.event.inputs.wazuh_version }}"
            VERSION="${VERSION#v}"
            CHART_VERSION=$(jq -r --arg v "$VERSION" '.versions[] | select(.version == $v) | .chart_version // "v1"' ${{ env.VERSIONS_FILE }})
            MATRIX="[{\"version\": \"${VERSION}\", \"chart_version\": \"${CHART_VERSION}\"}]"
            echo "Publishing specific version: ${VERSION} with chart ${CHART_VERSION}"
          else
            # Default version only
            CHART_VERSION=$(jq -r --arg v "$DEFAULT_VERSION" '.versions[] | select(.version == $v) | .chart_version // "v1"' ${{ env.VERSIONS_FILE }})
            MATRIX="[{\"version\": \"${DEFAULT_VERSION}\", \"chart_version\": \"${CHART_VERSION}\"}]"
            echo "Publishing default version: ${DEFAULT_VERSION} with chart ${CHART_VERSION}"
          fi

          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT
          echo "Matrix: ${MATRIX}"

  release:
    name: Release ${{ matrix.config.version }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Log in to GitHub container registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Prepare chart for Wazuh ${{ matrix.config.version }}
        id: prepare_chart
        run: |
          WAZUH_VERSION="${{ matrix.config.version }}"
          CHART_VERSION="${{ matrix.config.chart_version }}"
          CHART_PATH="charts/${CHART_VERSION}"

          echo "chart_path=${CHART_PATH}" >> $GITHUB_OUTPUT

          # Update image tag in values.yaml
          sed -i "s/tag: \"[0-9]*\.[0-9]*\.[0-9]*\"/tag: \"${WAZUH_VERSION}\"/" ${CHART_PATH}/values.yaml

          # Update version and appVersion in Chart.yaml
          sed -i "s/^version:.*/version: ${WAZUH_VERSION}/" ${CHART_PATH}/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${WAZUH_VERSION}\"/" ${CHART_PATH}/Chart.yaml

          echo "=== Chart configuration ==="
          echo "Wazuh version: ${WAZUH_VERSION}"
          echo "Chart folder: ${CHART_PATH}"
          echo ""
          echo "=== values.yaml (image section) ==="
          grep -A2 "^image:" ${CHART_PATH}/values.yaml
          echo ""
          echo "=== Chart.yaml ==="
          head -5 ${CHART_PATH}/Chart.yaml

      - name: Lint Helm chart
        run: |
          helm lint ${{ steps.prepare_chart.outputs.chart_path }}

      - name: Package Helm chart
        run: |
          helm package ${{ steps.prepare_chart.outputs.chart_path }}

      - name: Push Helm chart to OCI registry
        run: |
          WAZUH_VERSION="${{ matrix.config.version }}"
          CHART_FILE="wazuh-agent-${WAZUH_VERSION}.tgz"

          helm push "${CHART_FILE}" oci://${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/charts

          echo "Pushed: oci://${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/charts/wazuh-agent:${WAZUH_VERSION}"

      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: chart-wazuh-${{ matrix.config.version }}
          path: wazuh-agent-*.tgz
          retention-days: 5

  create-release:
    name: Create GitHub release
    needs: [prepare, release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.publish_all_versions == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all chart artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: chart-wazuh-*
          merge-multiple: true

      - name: Generate release notes
        id: release_notes
        run: |
          DEFAULT_VERSION="${{ needs.prepare.outputs.default_version }}"
          MATRIX='${{ needs.prepare.outputs.matrix }}'

          PREVIOUS_TAG=$(git tag -l --sort=-version:refname | head -n 1)

          cat << EOF > release_notes.md
          ## Wazuh Agent Helm Chart

          ### Supported Wazuh versions

          This release supports the following Wazuh agent versions:

          EOF

          echo "${MATRIX}" | jq -r '.[].version' | while read version; do
            if [ "$version" == "$DEFAULT_VERSION" ]; then
              echo "- **${version}** (default)" >> release_notes.md
            else
              echo "- ${version}" >> release_notes.md
            fi
          done

          cat << EOF >> release_notes.md

          ### Installation

          \`\`\`bash
          helm install wazuh-agent oci://${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/charts/wazuh-agent \\
            --version ${DEFAULT_VERSION} \\
            --namespace wazuh \\
            --create-namespace \\
            --set manager.address=<WAZUH_MANAGER_IP> \\
            --set registration.password=<PASSWORD>
          \`\`\`

          ### What's changed
          EOF

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD --no-merges -- charts/ | head -20 >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${DEFAULT_VERSION}" >> release_notes.md
          else
            echo "Initial release" >> release_notes.md
          fi

          cat release_notes.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.default_version }}
          name: Wazuh agent ${{ needs.prepare.outputs.default_version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/*.tgz
          token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Summary
    needs: [prepare, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Release summary

          ### Published versions
          | Wazuh version | Chart | OCI tag | Status |
          |---------------|-------|---------|--------|
          EOF

          MATRIX='${{ needs.prepare.outputs.matrix }}'
          DEFAULT_VERSION="${{ needs.prepare.outputs.default_version }}"

          echo "${MATRIX}" | jq -r '.[] | "\(.version)|\(.chart_version)"' | while IFS='|' read version chart_version; do
            if [ "$version" == "$DEFAULT_VERSION" ]; then
              VERSION_LABEL="${version} (default)"
            else
              VERSION_LABEL="${version}"
            fi
            echo "| ${VERSION_LABEL} | ${chart_version} | \`${version}\` | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          done

          cat << EOF >> $GITHUB_STEP_SUMMARY

          ### Installation

          \`\`\`bash
          helm install wazuh-agent oci://${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/charts/wazuh-agent --version ${DEFAULT_VERSION}
          \`\`\`

          ### Available versions
          EOF

          echo "${MATRIX}" | jq -r '.[].version' | while read version; do
            echo "- \`${version}\`" >> $GITHUB_STEP_SUMMARY
          done

  cleanup:
    name: Cleanup untagged images
    needs: [prepare, release]
    runs-on: ubuntu-latest
    steps:
      - name: Delete untagged container images
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = '${{ needs.prepare.outputs.owner_lower }}';
            const packageName = 'charts/wazuh-agent';

            console.log(`Fetching package versions for ${owner}/${packageName}...`);

            try {
              const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                package_type: 'container',
                package_name: packageName,
                username: owner,
                per_page: 100
              });

              console.log(`Found ${versions.data.length} package versions`);

              let deletedCount = 0;

              for (const version of versions.data) {
                const tags = version.metadata?.container?.tags || [];

                if (tags.length === 0) {
                  console.log(`Deleting untagged version: ${version.id} (${version.name})`);

                  try {
                    await github.rest.packages.deletePackageVersionForUser({
                      package_type: 'container',
                      package_name: packageName,
                      username: owner,
                      package_version_id: version.id
                    });
                    deletedCount++;
                    console.log(`Successfully deleted version ${version.id}`);
                  } catch (deleteError) {
                    console.log(`Failed to delete version ${version.id}: ${deleteError.message}`);
                  }
                } else {
                  console.log(`Keeping version ${version.id} with tags: ${tags.join(', ')}`);
                }
              }

              console.log(`Cleanup complete. Deleted ${deletedCount} untagged versions.`);

            } catch (error) {
              console.log('User API failed, trying organization API...');

              try {
                const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                  package_type: 'container',
                  package_name: packageName,
                  org: owner,
                  per_page: 100
                });

                console.log(`Found ${versions.data.length} package versions`);

                let deletedCount = 0;

                for (const version of versions.data) {
                  const tags = version.metadata?.container?.tags || [];

                  if (tags.length === 0) {
                    console.log(`Deleting untagged version: ${version.id} (${version.name})`);

                    try {
                      await github.rest.packages.deletePackageVersionForOrg({
                        package_type: 'container',
                        package_name: packageName,
                        org: owner,
                        package_version_id: version.id
                      });
                      deletedCount++;
                      console.log(`Successfully deleted version ${version.id}`);
                    } catch (deleteError) {
                      console.log(`Failed to delete version ${version.id}: ${deleteError.message}`);
                    }
                  } else {
                    console.log(`Keeping version ${version.id} with tags: ${tags.join(', ')}`);
                  }
                }

                console.log(`Cleanup complete. Deleted ${deletedCount} untagged versions.`);

              } catch (orgError) {
                console.log(`Organization API also failed: ${orgError.message}`);
                console.log('Cleanup skipped - package may not exist yet or insufficient permissions');
              }
            }
